<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高斯定律 - Gauss's Law | AetherViz Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #3B82F6 0%, #0EA5E9 100%);
            --bg-gradient: linear-gradient(180deg, #0F172A 0%, #1E3A5F 50%, #1E40AF 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-cyan: #22D3EE;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
        }
        
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        body {
            background: var(--bg-gradient);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }
        
        .nav-bar {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .sidebar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
        }
        
        .control-panel {
            background: rgba(30, 58, 95, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #0EA5E9 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #60A5FA 0%, #38BDF8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .slider-thumb {
            background: linear-gradient(135deg, #22D3EE 0%, #5EEAD4 100%);
        }
        
        .electric-field-line {
            stroke: url(#fieldGradient);
            stroke-width: 2;
            fill: none;
            opacity: 0.8;
        }
        
        .charge-positive {
            fill: #EF4444;
            filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.6));
        }
        
        .charge-negative {
            fill: #3B82F6;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.6));
        }
        
        .gaussian-surface {
            stroke: #22D3EE;
            stroke-width: 3;
            fill: rgba(34, 211, 238, 0.1);
            stroke-dasharray: 8, 4;
        }
        
        #canvas-container {
            position: relative;
            overflow: hidden;
        }
        
        #svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .quiz-panel {
            transition: all 0.3s ease;
        }
        
        .quiz-panel.hidden {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .quiz-fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #0EA5E9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .quiz-fab:hover {
            transform: scale(1.1);
        }
        
        .formula-box {
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid #3B82F6;
            padding: 16px;
            border-radius: 8px;
            margin: 12px 0;
        }
        
        .goal-checkbox:checked + label {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .field-vector {
            stroke: #22D3EE;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <nav class="nav-bar h-16 flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center text-white font-bold text-lg">G</div>
            <div>
                <h1 class="text-xl font-bold text-white">高斯定律</h1>
                <p class="text-xs text-cyan-400">Gauss's Law</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="resetSimulation()" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white transition-all">重置</button>
            <button onclick="randomExperiment()" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white transition-all">随机实验</button>
            <button onclick="toggleFullscreen()" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white transition-all">全屏</button>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧边栏 -->
        <aside class="sidebar w-80 flex-shrink-0 overflow-y-auto p-6 space-y-6">
            <!-- 学习目标 -->
            <div class="glass-panel p-5">
                <h3 class="text-lg font-semibold text-cyan-400 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    学习目标
                </h3>
                <div class="space-y-3">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="goal1" class="goal-checkbox mt-1 w-4 h-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500">
                        <label for="goal1" class="text-sm text-gray-300 cursor-pointer">理解电通量的物理意义</label>
                    </div>
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="goal2" class="goal-checkbox mt-1 w-4 h-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500">
                        <label for="goal2" class="text-sm text-gray-300 cursor-pointer">掌握高斯定律的积分形式</label>
                    </div>
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="goal3" class="goal-checkbox mt-1 w-4 h-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500">
                        <label for="goal3" class="text-sm text-gray-300 cursor-pointer">学会选择合适的高斯面</label>
                    </div>
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="goal4" class="goal-checkbox mt-1 w-4 h-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500">
                        <label for="goal4" class="text-sm text-gray-300 cursor-pointer">应用高斯定律计算电场</label>
                    </div>
                </div>
            </div>

            <!-- 核心公式 -->
            <div class="glass-panel p-5">
                <h3 class="text-lg font-semibold text-cyan-400 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    核心公式
                </h3>
                
                <div class="formula-box">
                    <p class="text-xs text-cyan-400 mb-2">积分形式</p>
                    <div class="text-white text-lg">$$\\displaystyle \\oint_S \\vec{E} \\cdot d\\vec{A} = \\frac{Q_{enc}}{\\varepsilon_0}$$</div>
                </div>
                
                <div class="formula-box">
                    <p class="text-xs text-cyan-400 mb-2">微分形式</p>
                    <div class="text-white text-lg">$$\\nabla \\cdot \\vec{E} = \\frac{\\rho}{\\varepsilon_0}$$</div>
                </div>
                
                <div class="formula-box">
                    <p class="text-xs text-cyan-400 mb-2">球对称情况</p>
                    <div class="text-white text-lg">$$E = \\frac{1}{4\\pi\\varepsilon_0} \\frac{Q}{r^2}$$</div>
                </div>
            </div>

            <!-- 原理解释 -->
            <div class="glass-panel p-5">
                <h3 class="text-lg font-semibold text-cyan-400 mb-4">原理解释</h3>
                <p class="text-sm text-gray-300 leading-relaxed mb-4">
                    高斯定律是电磁学中的基本定理之一，它揭示了电场与电荷分布之间的深刻联系。
                </p>
                <p class="text-sm text-gray-300 leading-relaxed mb-4">
                    <strong class="text-cyan-400">通俗理解：</strong>想象电荷是喷泉的源头，电场线就像水流向四面八方流出。高斯定律告诉我们：穿过任意闭合曲面的"水流总量"（电通量）只与曲面内包含的"喷泉数量"（电荷量）有关，而与曲面的形状无关。
                </p>
                <p class="text-sm text-gray-300 leading-relaxed">
                    <strong class="text-cyan-400">为什么重要：</strong>高斯定律让我们可以巧妙选择高斯面，将复杂的积分计算简化为简单的代数运算，是求解对称电荷分布电场的利器。
                </p>
            </div>

            <!-- 实际应用 -->
            <div class="glass-panel p-5">
                <h3 class="text-lg font-semibold text-cyan-400 mb-4">实际应用</h3>
                <ul class="text-sm text-gray-300 space-y-2">
                    <li class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
                        计算点电荷、球壳、无限长直导线的电场
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
                        设计电容器和电磁屏蔽装置
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
                        理解静电平衡和导体性质
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
                        分析等离子体和电离层物理
                    </li>
                </ul>
            </div>
        </aside>

        <!-- 中央主区域 -->
        <main class="flex-1 relative" id="canvas-container">
            <!-- Three.js 画布 -->
            <canvas id="three-canvas" class="w-full h-full"></canvas>
            
            <!-- SVG Overlay -->
            <svg id="svg-overlay" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <linearGradient id="fieldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:0.8" />
                        <stop offset="50%" style="stop-color:#22D3EE;stop-opacity:0.6" />
                        <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:0.2" />
                    </linearGradient>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#22D3EE" />
                    </marker>
                </defs>
                
                <!-- 电场线 -->
                <g id="field-lines"></g>
                
                <!-- 高斯面 -->
                <circle id="gaussian-circle" cx="400" cy="300" r="150" class="gaussian-surface" />
                
                <!-- 电荷 -->
                <g id="charges"></g>
                
                <!-- 电场矢量 -->
                <g id="field-vectors"></g>
            </svg>

            <!-- 底部控制面板 -->
            <div class="absolute bottom-6 left-6 right-80 control-panel rounded-2xl p-6">
                <div class="grid grid-cols-3 gap-6">
                    <!-- 电荷量控制 -->
                    <div>
                        <label class="text-sm text-cyan-400 mb-2 block">中心电荷量 Q (μC)</label>
                        <input type="range" id="charge-slider" min="-10" max="10" step="0.5" value="5" 
                               class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>-10</span>
                            <span id="charge-value" class="text-cyan-400 font-semibold">5.0</span>
                            <span>+10</span>
                        </div>
                    </div>
                    
                    <!-- 高斯面半径 -->
                    <div>
                        <label class="text-sm text-cyan-400 mb-2 block">高斯面半径 r (m)</label>
                        <input type="range" id="radius-slider" min="0.5" max="3" step="0.1" value="1.5" 
                               class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>0.5</span>
                            <span id="radius-value" class="text-cyan-400 font-semibold">1.5</span>
                            <span>3.0</span>
                        </div>
                    </div>
                    
                    <!-- 电场线密度 -->
                    <div>
                        <label class="text-sm text-cyan-400 mb-2 block">电场线密度</label>
                        <input type="range" id="density-slider" min="8" max="32" step="4" value="16" 
                               class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>稀疏</span>
                            <span id="density-value" class="text-cyan-400 font-semibold">16</span>
                            <span>密集</span>
                        </div>
                    </div>
                </div>
                
                <!-- 计算结果 -->
                <div class="mt-4 pt-4 border-t border-white/10 grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-xs text-gray-400">电通量 Φ</p>
                        <p id="flux-value" class="text-lg font-bold text-cyan-400">5.65 × 10⁵</p>
                        <p class="text-xs text-gray-500">N·m²/C</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">电场强度 E</p>
                        <p id="field-value" class="text-lg font-bold text-cyan-400">3.00 × 10⁴</p>
                        <p class="text-xs text-gray-500">N/C</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">包围电荷 Q<sub>enc</sub></p>
                        <p id="enclosed-value" class="text-lg font-bold text-cyan-400">5.00</p>
                        <p class="text-xs text-gray-500">μC</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 测验面板 -->
        <div id="quiz-panel" class="quiz-panel absolute right-6 top-20 w-80 glass-panel p-5 z-40 max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-cyan-400 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    快速测验
                </h3>
                <button onclick="toggleQuiz()" class="text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white/5 rounded-lg p-4">
                    <p class="text-sm text-gray-300 mb-3">1. 如果高斯面内没有电荷，电通量为多少？</p>
                    <div class="space-y-2">
                        <button onclick="checkAnswer(1, 'A', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">A. 零</button>
                        <button onclick="checkAnswer(1, 'B', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">B. 无限大</button>
                        <button onclick="checkAnswer(1, 'C', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">C. 取决于高斯面大小</button>
                    </div>
                </div>
                
                <div class="bg-white/5 rounded-lg p-4">
                    <p class="text-sm text-gray-300 mb-3">2. 点电荷的电场强度与距离的关系是？</p>
                    <div class="space-y-2">
                        <button onclick="checkAnswer(2, 'A', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">A. 与距离成反比</button>
                        <button onclick="checkAnswer(2, 'B', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">B. 与距离平方成反比 ✓</button>
                        <button onclick="checkAnswer(2, 'C', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-gray-300 transition-all">C. 与距离无关</button>
                    </div>
                </div>
                
                <div class="bg-white/5 rounded-lg p-4">
                    <p class="text-sm text-gray-300 mb-3">3. 高斯定律适用于？</p>
                    <div class="space-y-2">
                        <button onclick="checkAnswer(3, 'A', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">A. 只有静电场</button>
                        <button onclick="checkAnswer(3, 'B', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">B. 静电场和变化电场 ✓</button>
                        <button onclick="checkAnswer(3, 'C', this)" class="w-full text-left px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm text-gray-300 transition-all">C. 只有匀强电场</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 测验悬浮按钮 -->
    <div id="quiz-fab" class="quiz-fab hidden" onclick="toggleQuiz()">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
    </div>

    <!-- 页脚 -->
    <footer class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-center text-xs text-gray-500 z-30">
        <p>由 AetherViz Master 为你生成 ❤️ | 探索电磁学的奥秘，感受物理之美</p>
    </footer>

    <script>
        // Three.js 场景设置
        let scene, camera, renderer, chargeMesh, gaussianSphere;
        let chargeValue = 5;
        let gaussianRadius = 1.5;
        let fieldLineDensity = 16;
        
        const epsilon0 = 8.854e-12;
        const k = 1 / (4 * Math.PI * epsilon0);
        
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // 场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0F172A);
            
            // 相机
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 0, 8);
            
            // 渲染器
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('three-canvas'),
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // 灯光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 点光源（模拟电荷发光）
            const pointLight = new THREE.PointLight(0x3B82F6, 2, 20);
            pointLight.position.set(0, 0, 0);
            scene.add(pointLight);
            
            // 创建电荷球体
            createCharge();
            
            // 创建高斯面（透明球体）
            createGaussianSurface();
            
            // 创建电场线
            createFieldLines();
            
            // 动画循环
            animate();
        }
        
        function createCharge() {
            const geometry = new THREE.SphereGeometry(0.3, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: chargeValue > 0 ? 0xEF4444 : 0x3B82F6,
                emissive: chargeValue > 0 ? 0xEF4444 : 0x3B82F6,
                emissiveIntensity: 0.5,
                shininess: 100
            });
            chargeMesh = new THREE.Mesh(geometry, material);
            scene.add(chargeMesh);
            
            // 添加发光效果
            const glowGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: chargeValue > 0 ? 0xEF4444 : 0x3B82F6,
                transparent: true,
                opacity: 0.3
            });
            const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
            chargeMesh.add(glowMesh);
        }
        
        function createGaussianSurface() {
            const geometry = new THREE.SphereGeometry(gaussianRadius, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0x22D3EE,
                transparent: true,
                opacity: 0.1,
                side: THREE.DoubleSide,
                wireframe: false
            });
            gaussianSphere = new THREE.Mesh(geometry, material);
            scene.add(gaussianSphere);
            
            // 添加线框
            const wireframeGeometry = new THREE.SphereGeometry(gaussianRadius, 16, 16);
            const wireframeMaterial = new THREE.MeshBasicMaterial({
                color: 0x22D3EE,
                transparent: true,
                opacity: 0.5,
                wireframe: true
            });
            const wireframe = new THREE.Mesh(wireframeGeometry, wireframeMaterial);
            gaussianSphere.add(wireframe);
        }
        
        function createFieldLines() {
            // 清除旧的电场线
            const oldLines = scene.getObjectsByProperty('isFieldLine', true);
            oldLines.forEach(line => scene.remove(line));
            
            if (chargeValue === 0) return;
            
            const numLines = Math.abs(fieldLineDensity);
            const goldenRatio = (1 + Math.sqrt(5)) / 2;
            
            for (let i = 0; i < numLines; i++) {
                const theta = 2 * Math.PI * i / goldenRatio;
                const phi = Math.acos(1 - 2 * (i + 0.5) / numLines);
                
                const points = [];
                const startRadius = 0.4;
                const endRadius = 4;
                const steps = 50;
                
                for (let j = 0; j <= steps; j++) {
                    const r = startRadius + (endRadius - startRadius) * (j / steps);
                    const x = r * Math.sin(phi) * Math.cos(theta);
                    const y = r * Math.sin(phi) * Math.sin(theta);
                    const z = r * Math.cos(phi);
                    points.push(new THREE.Vector3(x, y, z));
                }
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({
                    color: chargeValue > 0 ? 0x3B82F6 : 0xEF4444,
                    transparent: true,
                    opacity: 0.6
                });
                
                const line = new THREE.Line(geometry, material);
                line.isFieldLine = true;
                scene.add(line);
                
                // 添加箭头
                if (chargeValue > 0) {
                    const arrowGeometry = new THREE.ConeGeometry(0.05, 0.2, 8);
                    const arrowMaterial = new THREE.MeshBasicMaterial({ color: 0x3B82F6 });
                    const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
                    arrow.position.copy(points[Math.floor(steps * 0.7)]);
                    arrow.lookAt(points[Math.floor(steps * 0.7) + 1]);
                    arrow.isFieldLine = true;
                    scene.add(arrow);
                }
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // 旋转高斯面
            if (gaussianSphere) {
                gaussianSphere.rotation.y += 0.002;
                gaussianSphere.rotation.x += 0.001;
            }
            
            // 脉冲效果
            if (chargeMesh) {
                const scale = 1 + 0.1 * Math.sin(Date.now() * 0.003);
                chargeMesh.scale.setScalar(scale);
            }
            
            renderer.render(scene, camera);
        }
        
        // 更新计算
        function updateCalculations() {
            const Q = chargeValue * 1e-6; // 转换为库仑
            const r = gaussianRadius;
            
            // 电通量 = Q / epsilon0
            const flux = Q / epsilon0;
            
            // 电场强度 E = k * Q / r^2
            const E = k * Q / (r * r);
            
            // 更新显示
            document.getElementById('flux-value').textContent = formatScientific(flux);
            document.getElementById('field-value').textContent = formatScientific(E);
            document.getElementById('enclosed-value').textContent = chargeValue.toFixed(2);
            
            // 更新 SVG
            updateSVG();
        }
        
        function formatScientific(num) {
            if (num === 0) return '0';
            const exponent = Math.floor(Math.log10(Math.abs(num)));
            const mantissa = num / Math.pow(10, exponent);
            return `${mantissa.toFixed(2)} × 10<sup>${exponent}</sup>`;
        }
        
        function updateSVG() {
            // 更新高斯面大小
            const svgRadius = 150 * (gaussianRadius / 3);
            document.getElementById('gaussian-circle').setAttribute('r', svgRadius);
            
            // 更新电场线
            const fieldLinesGroup = document.getElementById('field-lines');
            fieldLinesGroup.innerHTML = '';
            
            const numLines = Math.abs(fieldLineDensity);
            for (let i = 0; i < numLines; i++) {
                const angle = (2 * Math.PI * i) / numLines;
                const x1 = 400 + 30 * Math.cos(angle);
                const y1 = 300 + 30 * Math.sin(angle);
                const x2 = 400 + svgRadius * Math.cos(angle);
                const y2 = 300 + svgRadius * Math.sin(angle);
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'electric-field-line');
                fieldLinesGroup.appendChild(line);
            }
        }
        
        // 滑块事件
        document.getElementById('charge-slider').addEventListener('input', function(e) {
            chargeValue = parseFloat(e.target.value);
            document.getElementById('charge-value').textContent = chargeValue.toFixed(1);
            
            // 更新电荷颜色
            if (chargeMesh) {
                chargeMesh.material.color.setHex(chargeValue > 0 ? 0xEF4444 : 0x3B82F6);
                chargeMesh.material.emissive.setHex(chargeValue > 0 ? 0xEF4444 : 0x3B82F6);
            }
            
            createFieldLines();
            updateCalculations();
        });
        
        document.getElementById('radius-slider').addEventListener('input', function(e) {
            gaussianRadius = parseFloat(e.target.value);
            document.getElementById('radius-value').textContent = gaussianRadius.toFixed(1);
            
            // 更新高斯面大小
            if (gaussianSphere) {
                gaussianSphere.scale.setScalar(gaussianRadius / 1.5);
            }
            
            updateCalculations();
        });
        
        document.getElementById('density-slider').addEventListener('input', function(e) {
            fieldLineDensity = parseInt(e.target.value);
            document.getElementById('density-value').textContent = fieldLineDensity;
            createFieldLines();
        });
        
        // 测验面板切换
        function toggleQuiz() {
            const panel = document.getElementById('quiz-panel');
            const fab = document.getElementById('quiz-fab');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                fab.classList.add('hidden');
            } else {
                panel.classList.add('hidden');
                fab.classList.remove('hidden');
            }
        }
        
        // 答案检查
        function checkAnswer(question, answer, btn) {
            const correctAnswers = { 1: 'A', 2: 'B', 3: 'B' };
            const isCorrect = correctAnswers[question] === answer;
            
            if (isCorrect) {
                btn.style.background = 'rgba(34, 197, 94, 0.5)';
                btn.innerHTML += ' ✓';
            } else {
                btn.style.background = 'rgba(239, 68, 68, 0.5)';
                btn.innerHTML += ' ✗';
            }
        }
        
        // 重置
        function resetSimulation() {
            chargeValue = 5;
            gaussianRadius = 1.5;
            fieldLineDensity = 16;
            
            document.getElementById('charge-slider').value = 5;
            document.getElementById('radius-slider').value = 1.5;
            document.getElementById('density-slider').value = 16;
            
            document.getElementById('charge-value').textContent = '5.0';
            document.getElementById('radius-value').textContent = '1.5';
            document.getElementById('density-value').textContent = '16';
            
            createFieldLines();
            updateCalculations();
        }
        
        // 随机实验
        function randomExperiment() {
            chargeValue = (Math.random() * 20 - 10).toFixed(1);
            gaussianRadius = (Math.random() * 2.5 + 0.5).toFixed(1);
            
            document.getElementById('charge-slider').value = chargeValue;
            document.getElementById('radius-slider').value = gaussianRadius;
            
            document.getElementById('charge-value').textContent = parseFloat(chargeValue).toFixed(1);
            document.getElementById('radius-value').textContent = parseFloat(gaussianRadius).toFixed(1);
            
            createFieldLines();
            updateCalculations();
        }
        
        // 全屏
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // 窗口调整
        window.addEventListener('resize', function() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
        
        // 初始化
        initThreeJS();
        updateCalculations();
        updateSVG();
        
        // KaTeX 渲染
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        });
    </script>
</body>
</html>